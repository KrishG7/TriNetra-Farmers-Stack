<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>TriNetra | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Space+Grotesk:wght@500;700&display=swap"
        rel="stylesheet">

    <style>
        /* PREMIUM DARK THEME */
        :root {
            --bg-dark: #0f172a;
            --panel-dark: #1e293b;
            --accent-gold: #f59e0b;
            --accent-green: #10b981;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: #e2e8f0;
        }

        h1,
        h2,
        h3 {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Glass Panels */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass:hover {
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Navigation */
        .nav-item {
            border-left: 2px solid transparent;
            transition: all 0.3s;
            opacity: 0.7;
        }

        .nav-item:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.03);
        }

        .nav-item.active {
            border-left-color: var(--accent-green);
            opacity: 1;
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1), transparent);
        }

        /* Inputs */
        input,
        select {
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            transition: border 0.3s;
        }

        input:focus,
        select:focus {
            border-color: var(--accent-green);
            outline: none;
        }

        /* Map */
        #credit-map {
            height: 550px;
            width: 100%;
            border-radius: 0.75rem;
            filter: grayscale(20%) contrast(1.1);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden">

    <aside class="w-64 glass z-20 flex flex-col border-r-0">
        <div class="p-6">
            <h1 class="text-2xl font-bold tracking-wider text-white flex items-center gap-2">
                <i class="fas fa-eye text-emerald-400"></i> TRI<span class="text-emerald-400">NETRA</span>
            </h1>
            <p class="text-xs text-slate-400 mt-1 uppercase tracking-widest">Intelligence Stack</p>
        </div>

        <nav class="flex-1 py-4 space-y-1">
            <button onclick="showTab('dashboard')" id="nav-dashboard"
                class="nav-item active w-full text-left px-6 py-4 flex items-center gap-4">
                <i class="fas fa-grid-2 w-5"></i> Dashboard
            </button>
            <button onclick="showTab('market')" id="nav-market"
                class="nav-item w-full text-left px-6 py-4 flex items-center gap-4">
                <i class="fas fa-chart-line w-5"></i> Market Vision
            </button>
            <button onclick="showTab('soil')" id="nav-soil"
                class="nav-item w-full text-left px-6 py-4 flex items-center gap-4">
                <i class="fas fa-flask w-5"></i> Soil Vision
            </button>
            <button onclick="showTab('credit')" id="nav-credit"
                class="nav-item w-full text-left px-6 py-4 flex items-center gap-4">
                <i class="fas fa-satellite w-5"></i> Credit Vision
            </button>
        </nav>

        <div class="p-4 border-t border-slate-700/50">
            <div id="google_translate_element"></div>
            <a href="/logout"
                class="block mt-4 text-center text-xs text-red-400 hover:text-red-300 font-bold uppercase tracking-widest transition">
                Disconnect
            </a>
        </div>
    </aside>

    <main
        class="flex-1 flex flex-col relative overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')]">

        <header class="h-16 glass flex items-center justify-between px-8 z-10">
            <h2 id="page-title" class="text-lg font-medium text-slate-200">System Overview</h2>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-slate-800 border border-slate-700 text-xs font-mono text-emerald-400 cursor-pointer hover:bg-slate-700"
                    onclick="showTab('credit')">
                    <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></div>
                    <span id="gps-status">Active Region: Detecting...</span>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 relative">

            <div id="view-dashboard" class="space-y-6 animate-fade-in">
                <div class="glass rounded-2xl p-8 relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-r from-emerald-900/40 to-transparent"></div>
                    <div class="relative z-10">
                        <h1 class="text-4xl font-bold text-white mb-2">Welcome, <span class="text-emerald-400">{{
                                user.name if user else 'Farmer' }}</span></h1>
                        <p class="text-slate-300 max-w-xl text-lg font-light">
                            TriNetra AI is monitoring your fields. Weather conditions in your district are favorable for
                            Wheat sowing.
                        </p>
                    </div>
                    <i
                        class="fas fa-network-wired absolute -right-10 -bottom-10 text-9xl text-white/5 group-hover:scale-110 transition duration-700"></i>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="showTab('market')"
                        class="glass rounded-xl p-6 cursor-pointer hover:bg-slate-800/50 transition border-t-2 border-blue-500">
                        <div class="flex justify-between mb-4">
                            <span class="text-xs font-bold text-blue-400 uppercase">Economic</span>
                            <i class="fas fa-arrow-trend-up text-blue-500"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white">Price Predictor</h3>
                        <p class="text-sm text-slate-400 mt-2">7-Day Vertex AI Forecast</p>
                    </div>

                    <div onclick="showTab('soil')"
                        class="glass rounded-xl p-6 cursor-pointer hover:bg-slate-800/50 transition border-t-2 border-amber-500">
                        <div class="flex justify-between mb-4">
                            <span class="text-xs font-bold text-amber-400 uppercase">Ecological</span>
                            <i class="fas fa-flask text-amber-500"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white">Gemini Agronomist</h3>
                        <p class="text-sm text-slate-400 mt-2">N-P-K Balancing & Crop Logic</p>
                    </div>

                    <div onclick="showTab('credit')"
                        class="glass rounded-xl p-6 cursor-pointer hover:bg-slate-800/50 transition border-t-2 border-emerald-500">
                        <div class="flex justify-between mb-4">
                            <span class="text-xs font-bold text-emerald-400 uppercase">Financial</span>
                            <i class="fas fa-satellite text-emerald-500"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-white">Sat-Scoreâ„¢</h3>
                        <p class="text-sm text-slate-400 mt-2">Collateral-free Eligibility</p>
                    </div>
                </div>
            </div>

            <div id="view-market" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 glass rounded-xl p-6 h-fit">
                    <h3 class="text-lg font-bold text-blue-400 mb-6 border-b border-slate-700 pb-2">Configuration</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400 uppercase font-bold">Crop Type</label>
                            <select id="m_crop" class="w-full mt-1 p-3 rounded">
                                <option>Wheat</option>
                                <option>Rice</option>
                                <option>Cotton</option>
                                <option>Maize</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 uppercase font-bold">Target Market</label>
                            <select id="m_state" class="w-full mt-1 p-3 rounded">
                                <option>Haryana</option>
                                <option>Punjab</option>
                                <option>Maharashtra</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 uppercase font-bold">Prediction Date</label>
                            <input type="date" id="m_date" class="w-full mt-1 p-3 rounded">
                        </div>
                        <div>
                            <label class="text-xs text-slate-400 uppercase font-bold">Quantity (Q)</label>
                            <input type="number" id="m_qty" value="50" class="w-full mt-1 p-3 rounded">
                        </div>
                        <button onclick="runMarketAI()"
                            class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded shadow-lg shadow-blue-900/50 transition">
                            Run Prediction Model
                        </button>
                    </div>
                </div>
                <div class="lg:col-span-8 space-y-6 hidden" id="market-results">
                    <div class="glass rounded-xl p-6">
                        <div class="flex justify-between items-end mb-4">
                            <div>
                                <p class="text-sm text-slate-400 uppercase">Projected Rate</p>
                                <h2 id="m_res_price" class="text-5xl font-bold text-white">--</h2>
                            </div>
                            <span id="m_res_trend"
                                class="px-4 py-1 rounded-full text-sm font-bold bg-slate-800 border border-slate-600">--</span>
                        </div>
                        <div class="h-64">
                            <canvas id="marketChart"></canvas>
                        </div>
                        <p id="m_res_advice"
                            class="mt-4 text-blue-300 text-sm p-3 bg-blue-900/20 rounded border border-blue-900/50"></p>
                    </div>
                </div>
            </div>

            <div id="view-soil" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-4 glass rounded-xl p-6 h-fit">
                    <h3 class="text-lg font-bold text-amber-400 mb-6 border-b border-slate-700 pb-2">Soil Health Card
                    </h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs text-slate-400">N (mg/kg)</label><input id="s_n" value="140"
                                class="w-full p-2 mt-1 rounded"></div>
                        <div><label class="text-xs text-slate-400">P (mg/kg)</label><input id="s_p" value="40"
                                class="w-full p-2 mt-1 rounded"></div>
                        <div><label class="text-xs text-slate-400">K (mg/kg)</label><input id="s_k" value="100"
                                class="w-full p-2 mt-1 rounded"></div>
                        <div><label class="text-xs text-slate-400">pH</label><input id="s_ph" value="6.5"
                                class="w-full p-2 mt-1 rounded"></div>
                        <div class="col-span-2"><label class="text-xs text-slate-400">Rainfall (mm)</label><input
                                id="s_rain" value="120" class="w-full p-2 mt-1 rounded"></div>
                    </div>
                    <button onclick="runSoilAI()"
                        class="w-full mt-6 bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 rounded shadow-lg shadow-amber-900/50 transition">
                        Ask AI Agronomist
                    </button>
                </div>

                <div class="lg:col-span-8">
                    <div id="soil-loading" class="hidden glass rounded-xl p-12 text-center">
                        <i class="fas fa-circle-notch fa-spin text-4xl text-amber-500 mb-4"></i>
                        <p class="text-slate-300">Gemini is analyzing soil toxicity and crop suitability...</p>
                    </div>

                    <div id="soil-results" class="hidden space-y-6">
                        <div id="s_status_box" class="glass rounded-xl p-6 border-l-4">
                            <h2 id="s_status_title" class="text-2xl font-bold mb-2"></h2>
                            <p id="s_status_desc" class="text-slate-300 leading-relaxed"></p>
                        </div>

                        <div id="s_rec_container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-credit" class="hidden grid grid-cols-1 lg:grid-cols-12 gap-6">
                <div class="lg:col-span-8">
                    <div class="glass p-2 rounded-xl relative">
                        <div id="credit-map"></div>

                        <div class="absolute top-4 left-4 z-[400] w-64">
                            <div class="flex shadow-lg">
                                <input id="map-search" placeholder="Search City/Village..."
                                    class="w-full px-4 py-2 rounded-l bg-white text-slate-800 text-sm border-0 focus:ring-0">
                                <button onclick="searchLocation()"
                                    class="bg-blue-600 text-white px-4 rounded-r hover:bg-blue-700">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-4 glass rounded-xl p-6 flex flex-col h-full">
                    <h3 class="text-lg font-bold text-emerald-400 mb-6">Satellite Verification</h3>

                    <div class="space-y-4 flex-1">
                        <div class="bg-slate-800/50 p-4 rounded border border-slate-700">
                            <label class="text-xs text-slate-500 uppercase font-bold mb-2 block">Plot
                                Coordinates</label>
                            <div class="grid grid-cols-2 gap-2">
                                <div>
                                    <label class="text-[10px] text-slate-500">Lat</label>
                                    <input id="input-lat" type="number" step="0.0001"
                                        class="w-full p-2 text-sm rounded bg-slate-900 border border-slate-600 focus:border-emerald-500">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500">Lng</label>
                                    <input id="input-lng" type="number" step="0.0001"
                                        class="w-full p-2 text-sm rounded bg-slate-900 border border-slate-600 focus:border-emerald-500">
                                </div>
                            </div>
                            <button onclick="updateMapFromInput()"
                                class="w-full mt-2 text-xs bg-slate-700 hover:bg-slate-600 text-emerald-400 py-1 rounded">
                                Update Map Marker
                            </button>
                        </div>

                        <div class="mt-4">
                            <label class="text-xs text-slate-500 uppercase font-bold">Claimed Yield (Q/Acre)</label>
                            <input id="c_yield" placeholder="25"
                                class="w-full mt-1 p-3 rounded bg-slate-800 border border-slate-700">
                        </div>
                    </div>

                    <button onclick="runCreditAI()"
                        class="w-full mt-6 bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded shadow-lg shadow-emerald-900/50 transition">
                        Calculate Score
                    </button>

                    <div id="credit-res" class="hidden mt-6 pt-6 border-t border-slate-700 text-center animate-fade-in">
                        <p class="text-sm text-slate-400 uppercase">Credit Health Score</p>
                        <h2 id="c_score" class="text-6xl font-bold text-white my-2">--</h2>
                        <span id="c_badge" class="px-3 py-1 rounded bg-slate-700 text-xs">--</span>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <script>
        // --- CONFIG ---
        function googleTranslateElementInit() { new google.translate.TranslateElement({ pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE }, 'google_translate_element'); }

        let map, marker, marketChart;
        // Default to Center of India if GPS fails
        let userLat = 20.5937, userLng = 78.9629;

        window.onload = function () {
            document.getElementById('m_date').valueAsDate = new Date();
            getLocation();
        }

        // --- NAVIGATION ---
        function showTab(id) {
            document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${id}`).classList.add('active');

            const titles = { dashboard: "System Overview", market: "Market Intelligence", soil: "Soil Chemistry AI", credit: "Satellite Scoring" };
            document.getElementById('page-title').innerText = titles[id];

            if (id === 'credit') setTimeout(initMap, 200);
        }

        // --- GPS LOGIC ---
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    updateGlobalLocation(pos.coords.latitude, pos.coords.longitude);
                }, () => {
                    document.getElementById('gps-status').innerText = "GPS: Denied (Defaulting)";
                    // Still init map with default
                    if (document.getElementById('view-credit').classList.contains('hidden') === false) initMap();
                });
            }
        }

        function updateGlobalLocation(lat, lng) {
            userLat = lat;
            userLng = lng;
            document.getElementById('gps-status').innerHTML = `Active Region: ${lat.toFixed(2)}, ${lng.toFixed(2)}`;

            // Update Inputs
            document.getElementById('input-lat').value = lat.toFixed(5);
            document.getElementById('input-lng').value = lng.toFixed(5);

            // Update Map if active
            if (map && marker) {
                const newLatLng = new L.LatLng(lat, lng);
                marker.setLatLng(newLatLng);
                map.setView(newLatLng, 15);
            }
        }

        // --- MAP FUNCTIONS ---
        function initMap() {
            if (map) return;
            map = L.map('credit-map').setView([userLat, userLng], 15);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

            marker = L.marker([userLat, userLng], { draggable: true }).addTo(map)
                .bindPopup("Target Plot").openPopup();

            // Sync Marker Drag -> Inputs
            marker.on('dragend', e => {
                const p = e.target.getLatLng();
                updateGlobalLocation(p.lat, p.lng);
            });

            // Add Dummy Neighbors
            const neighbors = [[userLat + 0.003, userLng + 0.003], [userLat - 0.002, userLng - 0.004]];
            neighbors.forEach(n => L.circleMarker(n, { color: 'yellow', radius: 5 }).addTo(map).bindPopup("Neighbor Score: 780"));
        }

        // Search Location (Nominatim)
        async function searchLocation() {
            const query = document.getElementById('map-search').value;
            if (!query) return;

            const btn = document.querySelector('button[onclick="searchLocation()"]');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}`);
                const data = await res.json();
                if (data && data.length > 0) {
                    const lat = parseFloat(data[0].lat);
                    const lon = parseFloat(data[0].lon);
                    updateGlobalLocation(lat, lon);
                } else {
                    alert("Location not found");
                }
            } catch (e) { console.error(e); }

            btn.innerHTML = '<i class="fas fa-search"></i>';
        }

        // Update from Manual Inputs
        function updateMapFromInput() {
            const lat = parseFloat(document.getElementById('input-lat').value);
            const lng = parseFloat(document.getElementById('input-lng').value);
            if (!isNaN(lat) && !isNaN(lng)) {
                updateGlobalLocation(lat, lng);
            }
        }

        // --- MARKET AI ---
        async function runMarketAI() {
            const fd = new FormData();
            fd.append('crop_name', document.getElementById('m_crop').value);
            fd.append('state', document.getElementById('m_state').value);
            fd.append('quantity', document.getElementById('m_qty').value);
            fd.append('target_date_str', document.getElementById('m_date').value);

            const res = await fetch('/api/analyze/market', { method: 'POST', body: fd });
            const data = await res.json();

            document.getElementById('market-results').classList.remove('hidden');
            document.getElementById('m_res_price').innerText = `â‚¹${data.forecast_price}`;
            document.getElementById('m_res_advice').innerText = data.recommendation;

            const trendEl = document.getElementById('m_res_trend');
            trendEl.innerText = data.trend;
            trendEl.className = `px-4 py-1 rounded-full text-sm font-bold border ${data.trend === 'RISING' ? 'bg-emerald-900/50 text-emerald-400 border-emerald-500' : 'bg-red-900/50 text-red-400 border-red-500'}`;

            if (marketChart) marketChart.destroy();
            const ctx = document.getElementById('marketChart').getContext('2d');
            marketChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.forecast.map(d => d.date),
                    datasets: [{
                        label: 'Price Trend',
                        data: data.forecast.map(d => d.price),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    plugins: { legend: { labels: { color: 'white' } } },
                    scales: {
                        y: { grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // --- SOIL AI ---
        async function runSoilAI() {
            document.getElementById('soil-loading').classList.remove('hidden');
            document.getElementById('soil-results').classList.add('hidden');

            const fd = new FormData();
            fd.append('district', 'Pune');
            fd.append('nitrogen', document.getElementById('s_n').value);
            fd.append('phosphorus', document.getElementById('s_p').value);
            fd.append('potassium', document.getElementById('s_k').value);
            fd.append('ph', document.getElementById('s_ph').value);
            fd.append('rainfall', document.getElementById('s_rain').value);

            try {
                const res = await fetch('/api/analyze/soil', { method: 'POST', body: fd });
                const data = await res.json();

                document.getElementById('soil-loading').classList.add('hidden');
                document.getElementById('soil-results').classList.remove('hidden');

                const statusBox = document.getElementById('s_status_box');
                const title = document.getElementById('s_status_title');

                if (data.cultivable) {
                    statusBox.className = "glass rounded-xl p-6 border-l-4 border-emerald-500 bg-emerald-900/20";
                    title.className = "text-2xl font-bold mb-2 text-emerald-400";
                } else {
                    statusBox.className = "glass rounded-xl p-6 border-l-4 border-red-500 bg-red-900/20";
                    title.className = "text-2xl font-bold mb-2 text-red-400";
                }
                title.innerText = data.message;
                document.getElementById('s_status_desc').innerText = data.explanation;

                const container = document.getElementById('s_rec_container');
                container.innerHTML = "";

                data.crops.forEach(crop => {
                    const html = `
                        <div class="glass p-4 rounded-xl border border-slate-700">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="font-bold text-white text-lg">${crop.crop}</h4>
                                <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-300">${crop.confidence || 'Best Fit'}</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-center text-xs mb-3">
                                <div class="bg-slate-800 p-2 rounded"><span class="block text-slate-500">Urea</span><span class="text-white font-bold">${crop.urea_dose || '0'}</span></div>
                                <div class="bg-slate-800 p-2 rounded"><span class="block text-slate-500">DAP</span><span class="text-white font-bold">${crop.dap_dose || '0'}</span></div>
                                <div class="bg-slate-800 p-2 rounded"><span class="block text-slate-500">MOP</span><span class="text-white font-bold">${crop.mop_dose || '0'}</span></div>
                            </div>
                            <p class="text-xs text-slate-400 italic">"${crop.reason}"</p>
                        </div>
                    `;
                    container.innerHTML += html;
                });

            } catch (e) {
                alert("AI Error. Check console.");
                console.error(e);
            }
        }

        // --- CREDIT AI ---
        // --- CREDIT AI (Final Version with High Risk Handling) ---
        async function runCreditAI() {
            // Show loading spinner
            document.getElementById('c_score').innerHTML = '<i class="fas fa-circle-notch fa-spin text-4xl"></i>';
            const area = document.getElementById('credit-res');
            area.classList.remove('hidden');

            const fd = new FormData();
            fd.append('lat', userLat);
            fd.append('lng', userLng);
            fd.append('claimed_yield', document.getElementById('c_yield').value);

            try {
                const res = await fetch('/api/analyze/credit', { method: 'POST', body: fd });
                const data = await res.json();

                // 1. REJECTION SCENARIOS (Red Badge)
                // Trigger RED if satellite rejects land OR if score is 0 (Liar Penalty)
                if (data.status === "REJECTED" || data.health_score === 0) {
                    document.getElementById('c_score').innerText = "0";
                    const badge = document.getElementById('c_badge');

                    // Custom error message
                    if (data.status === "REJECTED") {
                        // Real satellite rejection (e.g. Forest, Water)
                        badge.innerText = `ðŸš« ${data.land_type ? data.land_type.toUpperCase() : 'INVALID LAND'} (NOT FARMLAND)`;
                    } else {
                        // Yield Lie Penalty
                        badge.innerText = "ðŸš« HIGH RISK: UNREALISTIC YIELD";
                    }

                    // Red Styling
                    badge.className = "px-4 py-2 rounded bg-red-900 text-red-400 font-bold border border-red-500";
                }
                else {
                    // 2. SUCCESS SCENARIOS (Green/Amber Badge)
                    document.getElementById('c_score').innerText = (data.health_score * 100).toFixed(0);
                    const badge = document.getElementById('c_badge');

                    if (data.verification.likelihood === 'high') {
                        badge.innerText = "ELIGIBLE FOR LOAN";
                        badge.className = "px-4 py-2 rounded bg-emerald-900 text-emerald-400 font-bold border border-emerald-500";
                    } else {
                        badge.innerText = "FLAGGED FOR REVIEW";
                        badge.className = "px-4 py-2 rounded bg-amber-900 text-amber-400 font-bold border border-amber-500";
                    }
                }
            } catch (e) {
                console.error(e);
                document.getElementById('c_score').innerText = "ERR";
                document.getElementById('c_badge').innerText = "CONNECTION FAILED";
            }
        }

    </script>
</body>

</html>